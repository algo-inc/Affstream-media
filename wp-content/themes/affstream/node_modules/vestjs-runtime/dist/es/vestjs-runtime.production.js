import{invariant as e,isNullish as t,isNotNullish as n,assign as r,bus as o,optionalFunctionValue as i,tinyState as u,deferThrow as s,text as l,isStringValue as c,hasOwnProperty as a}from"vest-utils";import{createCascade as d}from"context";var f,y;"function"==typeof SuppressedError&&SuppressedError,function(e){e.Type="$type",e.Keys="keys",e.Key="key",e.Parent="parent",e.Data="data",e.AllowReorder="allowReorder"}(f||(f={})),function(e){e.Type="$",e.Keys="K",e.Key="k",e.Parent="P",e.Data="D",e.AllowReorder="aR"}(y||(y={}));const p={[f.Type]:y.Type,[f.Keys]:y.Keys,[f.Parent]:y.Parent,[f.Data]:y.Data,[f.Key]:y.Key,[f.AllowReorder]:y.AllowReorder},h=Object.entries(p).reduce(((e,[t,n])=>Object.assign(e,{[n]:t})),{});class v{static setParent(e,t){return e.parent=t,e}static saveOutput(e,t){return e.output=t,e}static setKey(e,t){return e.key=t,e}static addChild(t,n){var r;e(t),t.children=null!==(r=t.children)&&void 0!==r?r:[],t.children.push(n),v.setParent(n,t)}static removeChild(e,t){var n,r;e.children=null!==(r=null===(n=e.children)||void 0===n?void 0:n.filter((e=>e!==t)))&&void 0!==r?r:null}static addChildKey(t,n,r){var o;e(t),t.keys=null!==(o=t.keys)&&void 0!==o?o:{},t.keys[n]=r}static slice(e,n){t(e.children)||(e.children.length=n)}static setData(e,t){e.data=t}}var O;!function(e){e.NO_ACTIVE_ISOLATE="Not within an active isolate",e.UNABLE_TO_PICK_NEXT_ISOLATE="Unable to pick next isolate. This is a bug, please report it to the Vest maintainers.",e.ENCOUNTERED_THE_SAME_KEY_TWICE='Encountered the same key "{key}" twice. This may lead to inconsistent or overriding of results.',e.IVALID_ISOLATE_CANNOT_PARSE="Invalid isolate was passed to IsolateSerializer. Cannot proceed."}(O||(O={}));class _{static at(e,n){var r,o;return t(e)?null:null!==(o=null===(r=e.children)||void 0===r?void 0:r[n])&&void 0!==o?o:null}static cursor(e){var n,r;return t(e)?0:null!==(r=null===(n=e.children)||void 0===n?void 0:n.length)&&void 0!==r?r:0}static canReorder(e){return!t(e)&&_.allowsReorder(e.parent)}static allowsReorder(e){return!0===(null==e?void 0:e.allowReorder)}static usesKey(e){return!t(e)&&n(e.key)}static getChildByKey(e,n){var r,o;return t(e)?null:null!==(o=null===(r=e.keys)||void 0===r?void 0:r[n])&&void 0!==o?o:null}}function R(e,t){return(null==e?void 0:e[f.Type])===t}function E(e,t){return R(e,t[f.Type])}var T=Object.freeze({__proto__:null,isIsolateType:R,isSameIsolateIdentity:function(e,t){return Object.is(e,t)||E(e,t)&&e.key===t.key},isSameIsolateType:E});const N=d(((t,n)=>{if(n)return null;e(t.historyRoot);const[o]=t.historyRoot(),i={};return r(i,{historyNode:o,runtimeNode:null,runtimeRoot:null,stateRef:t}),i})),I=N.run,m={Run:I,addNodeToHistory:P,createRef:function(e,t){return Object.freeze({Bus:o.createBus(),Reconciler:e,appData:i(t),historyRoot:u.createTinyState(null)})},persist:A,reset:function(){const[,,e]=K();e()},useAvailableRoot:function(){const e=g();if(e)return e;const[t]=K();return t},useCurrentCursor:function(){const e=w();return e?_.cursor(e):0},useHistoryRoot:K,useLoadRootNode:function(e){S(e)},useXAppData:function(){return C().stateRef.appData}};function A(e){const t=N.useX();return(...n)=>{var r;const o=null!==(r=N.use())&&void 0!==r?r:t;return N.run(o.stateRef,(()=>e(...n)))}}function C(){return N.useX()}function K(){return C().stateRef.historyRoot()}function k(){return C().historyNode}function b(){const e=w(),t=k();return e?_.at(t,_.cursor(e)):t}function P(t){const n=w();n?function(t){const n=w();e(n,O.NO_ACTIVE_ISOLATE),v.addChild(n,t)}(t):S(t),v.setParent(t,n)}function S(e){const[,t]=K();t(e)}function w(){var e;return null!==(e=C().runtimeNode)&&void 0!==e?e:null}function g(){return C().runtimeRoot}class j{static reconcile(n){const r=function(e,n){var r;if(t(n))return function(e){if(_.usesKey(e))return j.handleIsolateNodeWithKey(e);return e}(e);if(!E(e,n))return e;const o=C().stateRef.Reconciler;return null!==(r=o(e,n))&&void 0!==r?r:function(e,n){return t(n),e}(e,n)}(n,b());return e(r,O.UNABLE_TO_PICK_NEXT_ISOLATE),r}static dropNextNodesOnReorder(e,t,n){const r=e(t,n);return r&&function(){const e=w(),t=k();if(!t||!e)return;v.slice(t,_.cursor(e))}(),r}static handleIsolateNodeWithKey(n){e(_.usesKey(n));const r=function(e){if(t(e))return null;const n=C().historyNode;return _.getChildByKey(n,e)}(n.key);let o=n;return t(r)||(o=r),function(n,r){if(!n)return;const o=w();e(o,O.NO_ACTIVE_ISOLATE),t(_.getChildByKey(o,n))?v.addChildKey(o,n,r):s(l(O.ENCOUNTERED_THE_SAME_KEY_TWICE,{key:n}))}(n.key,n),o}}class D{static create(e,t,n,r){const o=w(),i=v.setParent(function(e,t,n=null){const r=null!=t?t:{},{allowReorder:o}=r,i=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}return n}(r,["allowReorder"]);return{[f.AllowReorder]:o,[f.Keys]:null,[f.Parent]:null,[f.Type]:e,[f.Data]:i,children:null,key:n,output:null}}(e,n,r),o),u=j.reconcile(i),s=b(),l=Object.is(u,i)?function(e,t,n){const r=g(),o=I(Object.assign({historyNode:e,runtimeNode:t},!r&&{runtimeRoot:t}),(()=>n(t)));return t.output=o,o}(s,i,t):u.output;return v.setParent(u,o),v.saveOutput(u,l),P(u),u}}function L(e,n,r){if(t(e.children))return;let o=!1;for(const s of e.children){if(o)return;if((t(r)||i(r,s))&&n(s,u),o)return;L(s,((e,t)=>{n(e,(()=>{t(),u()}))}),r)}function u(){o=!0}}function B(e,t,n){let r=!1;return L(e,((e,n)=>{t(e)&&(n(),r=!0)}),n),r}function x(e,t){let n=e;do{if(t(n))return n;n=n.parent}while(n);return null}var z=Object.freeze({__proto__:null,closest:x,closestExists:function(e,t){return!!x(e,t)},every:function(e,t,n){let r=!0;return L(e,((e,n)=>{t(e)||(n(),r=!1)}),n),r},find:function(e,t,n){let r=null;return L(e,((e,n)=>{t(e)&&(n(),r=e)}),n),r},findClosest:function(e,t){var n,r;let o=null,i=e;for(;i&&(o=null!==(r=null===(n=i.children)||void 0===n?void 0:n.find(t))&&void 0!==r?r:null,!o);)i=i.parent;return o},has:function(e,t){return B(e,(()=>!0),t)},pluck:function(e,t,n){L(e,(e=>{t(e)&&e.parent&&v.removeChild(e.parent,e)}),n)},some:B,walk:L});function V(){return C().stateRef.Bus}function U(e,n){const r=V().emit;return t(e)||r(e,n),A(r)}var W=Object.freeze({__proto__:null,useBus:V,useEmit:U,usePrepareEmitter:function(e){const t=U();return n=>t(e,n)}});class X{static deserialize(e){const t=c(e)?JSON.parse(e):Object.assign({},e);X.validateIsolate(t);const r=[t];for(;r.length;){const e=r.shift(),t=X.getChildren(e);for(const t in h){const r=e[t];n(r)&&(e[h[t]]=r,delete e[t])}t&&(e.children=t.map((t=>{var n;const o=Object.assign({},t);v.setParent(o,e),r.push(o);const i=o.key;return i&&(e.keys=null!==(n=e.keys)&&void 0!==n?n:{},e.keys[i]=o),o})))}return t}static serialize(e){return t(e)?"":JSON.stringify(H(e))}static getChildren(e){return e.children?[...e.children]:null}static validateIsolate(t){e(a(t,f.Type)||a(t,p[f.Type]),l(O.IVALID_ISOLATE_CANNOT_PARSE))}}function H(e){const n={};e.children&&(n.children=e.children.map(H));for(const r in e){if("children"===r)continue;if(J(r))continue;const o=e[r];t(o)||(a(p,r)?n[p[r]]=o:n[r]=o)}return n}function J(e){return[f.Parent,f.Keys].includes(e)}export{W as Bus,D as Isolate,_ as IsolateInspector,v as IsolateMutator,T as IsolateSelectors,X as IsolateSerializer,j as Reconciler,m as VestRuntime,z as Walker};
