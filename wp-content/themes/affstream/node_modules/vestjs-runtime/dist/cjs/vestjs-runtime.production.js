"use strict";var e,t,n=require("vest-utils"),r=require("context");"function"==typeof SuppressedError&&SuppressedError,function(e){e.Type="$type",e.Keys="keys",e.Key="key",e.Parent="parent",e.Data="data",e.AllowReorder="allowReorder"}(e||(e={})),function(e){e.Type="$",e.Keys="K",e.Key="k",e.Parent="P",e.Data="D",e.AllowReorder="aR"}(t||(t={}));const i={[e.Type]:t.Type,[e.Keys]:t.Keys,[e.Parent]:t.Parent,[e.Data]:t.Data,[e.Key]:t.Key,[e.AllowReorder]:t.AllowReorder},o=Object.entries(i).reduce(((e,[t,n])=>Object.assign(e,{[n]:t})),{});class s{static setParent(e,t){return e.parent=t,e}static saveOutput(e,t){return e.output=t,e}static setKey(e,t){return e.key=t,e}static addChild(e,t){var r;n.invariant(e),e.children=null!==(r=e.children)&&void 0!==r?r:[],e.children.push(t),s.setParent(t,e)}static removeChild(e,t){var n,r;e.children=null!==(r=null===(n=e.children)||void 0===n?void 0:n.filter((e=>e!==t)))&&void 0!==r?r:null}static addChildKey(e,t,r){var i;n.invariant(e),e.keys=null!==(i=e.keys)&&void 0!==i?i:{},e.keys[t]=r}static slice(e,t){n.isNullish(e.children)||(e.children.length=t)}static setData(e,t){e.data=t}}var l;!function(e){e.NO_ACTIVE_ISOLATE="Not within an active isolate",e.UNABLE_TO_PICK_NEXT_ISOLATE="Unable to pick next isolate. This is a bug, please report it to the Vest maintainers.",e.ENCOUNTERED_THE_SAME_KEY_TWICE='Encountered the same key "{key}" twice. This may lead to inconsistent or overriding of results.',e.IVALID_ISOLATE_CANNOT_PARSE="Invalid isolate was passed to IsolateSerializer. Cannot proceed."}(l||(l={}));class u{static at(e,t){var r,i;return n.isNullish(e)?null:null!==(i=null===(r=e.children)||void 0===r?void 0:r[t])&&void 0!==i?i:null}static cursor(e){var t,r;return n.isNullish(e)?0:null!==(r=null===(t=e.children)||void 0===t?void 0:t.length)&&void 0!==r?r:0}static canReorder(e){return!n.isNullish(e)&&u.allowsReorder(e.parent)}static allowsReorder(e){return!0===(null==e?void 0:e.allowReorder)}static usesKey(e){return!n.isNullish(e)&&n.isNotNullish(e.key)}static getChildByKey(e,t){var r,i;return n.isNullish(e)?null:null!==(i=null===(r=e.keys)||void 0===r?void 0:r[t])&&void 0!==i?i:null}}function a(t,n){return(null==t?void 0:t[e.Type])===n}function c(t,n){return a(t,n[e.Type])}var d=Object.freeze({__proto__:null,isIsolateType:a,isSameIsolateIdentity:function(e,t){return Object.is(e,t)||c(e,t)&&e.key===t.key},isSameIsolateType:c});const f=r.createCascade(((e,t)=>{if(t)return null;n.invariant(e.historyRoot);const[r]=e.historyRoot(),i={};return n.assign(i,{historyNode:r,runtimeNode:null,runtimeRoot:null,stateRef:e}),i})),y=f.run,h={Run:y,addNodeToHistory:_,createRef:function(e,t){return Object.freeze({Bus:n.bus.createBus(),Reconciler:e,appData:n.optionalFunctionValue(t),historyRoot:n.tinyState.createTinyState(null)})},persist:p,reset:function(){const[,,e]=N();e()},useAvailableRoot:function(){const e=I();if(e)return e;const[t]=N();return t},useCurrentCursor:function(){const e=E();return e?u.cursor(e):0},useHistoryRoot:N,useLoadRootNode:function(e){T(e)},useXAppData:function(){return v().stateRef.appData}};function p(e){const t=f.useX();return(...n)=>{var r;const i=null!==(r=f.use())&&void 0!==r?r:t;return f.run(i.stateRef,(()=>e(...n)))}}function v(){return f.useX()}function N(){return v().stateRef.historyRoot()}function O(){return v().historyNode}function R(){const e=E(),t=O();return e?u.at(t,u.cursor(e)):t}function _(e){const t=E();t?function(e){const t=E();n.invariant(t,l.NO_ACTIVE_ISOLATE),s.addChild(t,e)}(e):T(e),s.setParent(e,t)}function T(e){const[,t]=N();t(e)}function E(){var e;return null!==(e=v().runtimeNode)&&void 0!==e?e:null}function I(){return v().runtimeRoot}class A{static reconcile(e){const t=function(e,t){var r;if(n.isNullish(t))return function(e){if(u.usesKey(e))return A.handleIsolateNodeWithKey(e);return e}(e);if(!c(e,t))return e;const i=v().stateRef.Reconciler;return null!==(r=i(e,t))&&void 0!==r?r:function(e,t){return n.isNullish(t),e}(e,t)}(e,R());return n.invariant(t,l.UNABLE_TO_PICK_NEXT_ISOLATE),t}static dropNextNodesOnReorder(e,t,n){const r=e(t,n);return r&&function(){const e=E(),t=O();if(!t||!e)return;s.slice(t,u.cursor(e))}(),r}static handleIsolateNodeWithKey(e){n.invariant(u.usesKey(e));const t=function(e){if(n.isNullish(e))return null;const t=v().historyNode;return u.getChildByKey(t,e)}(e.key);let r=e;return n.isNullish(t)||(r=t),function(e,t){if(!e)return;const r=E();n.invariant(r,l.NO_ACTIVE_ISOLATE),n.isNullish(u.getChildByKey(r,e))?s.addChildKey(r,e,t):n.deferThrow(n.text(l.ENCOUNTERED_THE_SAME_KEY_TWICE,{key:e}))}(e.key,e),r}}function C(e,t,r){if(n.isNullish(e.children))return;let i=!1;for(const s of e.children){if(i)return;if((n.isNullish(r)||n.optionalFunctionValue(r,s))&&t(s,o),i)return;C(s,((e,n)=>{t(e,(()=>{n(),o()}))}),r)}function o(){i=!0}}function K(e,t,n){let r=!1;return C(e,((e,n)=>{t(e)&&(n(),r=!0)}),n),r}function k(e,t){let n=e;do{if(t(n))return n;n=n.parent}while(n);return null}var S=Object.freeze({__proto__:null,closest:k,closestExists:function(e,t){return!!k(e,t)},every:function(e,t,n){let r=!0;return C(e,((e,n)=>{t(e)||(n(),r=!1)}),n),r},find:function(e,t,n){let r=null;return C(e,((e,n)=>{t(e)&&(n(),r=e)}),n),r},findClosest:function(e,t){var n,r;let i=null,o=e;for(;o&&(i=null!==(r=null===(n=o.children)||void 0===n?void 0:n.find(t))&&void 0!==r?r:null,!i);)o=o.parent;return i},has:function(e,t){return K(e,(()=>!0),t)},pluck:function(e,t,n){C(e,(e=>{t(e)&&e.parent&&s.removeChild(e.parent,e)}),n)},some:K,walk:C});function P(){return v().stateRef.Bus}function m(e,t){const r=P().emit;return n.isNullish(e)||r(e,t),p(r)}var w=Object.freeze({__proto__:null,useBus:P,useEmit:m,usePrepareEmitter:function(e){const t=m();return n=>t(e,n)}});class b{static deserialize(e){const t=n.isStringValue(e)?JSON.parse(e):Object.assign({},e);b.validateIsolate(t);const r=[t];for(;r.length;){const e=r.shift(),t=b.getChildren(e);for(const t in o){const r=e[t];n.isNotNullish(r)&&(e[o[t]]=r,delete e[t])}t&&(e.children=t.map((t=>{var n;const i=Object.assign({},t);s.setParent(i,e),r.push(i);const o=i.key;return o&&(e.keys=null!==(n=e.keys)&&void 0!==n?n:{},e.keys[o]=i),i})))}return t}static serialize(e){return n.isNullish(e)?"":JSON.stringify(g(e))}static getChildren(e){return e.children?[...e.children]:null}static validateIsolate(t){n.invariant(n.hasOwnProperty(t,e.Type)||n.hasOwnProperty(t,i[e.Type]),n.text(l.IVALID_ISOLATE_CANNOT_PARSE))}}function g(e){const t={};e.children&&(t.children=e.children.map(g));for(const r in e){if("children"===r)continue;if(x(r))continue;const o=e[r];n.isNullish(o)||(n.hasOwnProperty(i,r)?t[i[r]]=o:t[r]=o)}return t}function x(t){return[e.Parent,e.Keys].includes(t)}exports.Bus=w,exports.Isolate=class{static create(t,n,r,i){const o=E(),l=s.setParent(function(t,n,r=null){const i=null!=n?n:{},{allowReorder:o}=i,s=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(i,["allowReorder"]);return{[e.AllowReorder]:o,[e.Keys]:null,[e.Parent]:null,[e.Type]:t,[e.Data]:s,children:null,key:r,output:null}}(t,r,i),o),u=A.reconcile(l),a=R(),c=Object.is(u,l)?function(e,t,n){const r=I(),i=y(Object.assign({historyNode:e,runtimeNode:t},!r&&{runtimeRoot:t}),(()=>n(t)));return t.output=i,i}(a,l,n):u.output;return s.setParent(u,o),s.saveOutput(u,c),_(u),u}},exports.IsolateInspector=u,exports.IsolateMutator=s,exports.IsolateSelectors=d,exports.IsolateSerializer=b,exports.Reconciler=A,exports.VestRuntime=h,exports.Walker=S;
