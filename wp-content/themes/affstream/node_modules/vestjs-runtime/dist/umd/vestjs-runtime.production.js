!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vest-utils"),require("context")):"function"==typeof define&&define.amd?define(["exports","vest-utils","context"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["vestjs-runtime"]={},e["vest-utils"],e.context)}(this,(function(e,t,n){"use strict";var r,i;"function"==typeof SuppressedError&&SuppressedError,function(e){e.Type="$type",e.Keys="keys",e.Key="key",e.Parent="parent",e.Data="data",e.AllowReorder="allowReorder"}(r||(r={})),function(e){e.Type="$",e.Keys="K",e.Key="k",e.Parent="P",e.Data="D",e.AllowReorder="aR"}(i||(i={}));const o={[r.Type]:i.Type,[r.Keys]:i.Keys,[r.Parent]:i.Parent,[r.Data]:i.Data,[r.Key]:i.Key,[r.AllowReorder]:i.AllowReorder},s=Object.entries(o).reduce(((e,[t,n])=>Object.assign(e,{[n]:t})),{});class l{static setParent(e,t){return e.parent=t,e}static saveOutput(e,t){return e.output=t,e}static setKey(e,t){return e.key=t,e}static addChild(e,n){var r;t.invariant(e),e.children=null!==(r=e.children)&&void 0!==r?r:[],e.children.push(n),l.setParent(n,e)}static removeChild(e,t){var n,r;e.children=null!==(r=null===(n=e.children)||void 0===n?void 0:n.filter((e=>e!==t)))&&void 0!==r?r:null}static addChildKey(e,n,r){var i;t.invariant(e),e.keys=null!==(i=e.keys)&&void 0!==i?i:{},e.keys[n]=r}static slice(e,n){t.isNullish(e.children)||(e.children.length=n)}static setData(e,t){e.data=t}}var u;!function(e){e.NO_ACTIVE_ISOLATE="Not within an active isolate",e.UNABLE_TO_PICK_NEXT_ISOLATE="Unable to pick next isolate. This is a bug, please report it to the Vest maintainers.",e.ENCOUNTERED_THE_SAME_KEY_TWICE='Encountered the same key "{key}" twice. This may lead to inconsistent or overriding of results.',e.IVALID_ISOLATE_CANNOT_PARSE="Invalid isolate was passed to IsolateSerializer. Cannot proceed."}(u||(u={}));class a{static at(e,n){var r,i;return t.isNullish(e)?null:null!==(i=null===(r=e.children)||void 0===r?void 0:r[n])&&void 0!==i?i:null}static cursor(e){var n,r;return t.isNullish(e)?0:null!==(r=null===(n=e.children)||void 0===n?void 0:n.length)&&void 0!==r?r:0}static canReorder(e){return!t.isNullish(e)&&a.allowsReorder(e.parent)}static allowsReorder(e){return!0===(null==e?void 0:e.allowReorder)}static usesKey(e){return!t.isNullish(e)&&t.isNotNullish(e.key)}static getChildByKey(e,n){var r,i;return t.isNullish(e)?null:null!==(i=null===(r=e.keys)||void 0===r?void 0:r[n])&&void 0!==i?i:null}}function c(e,t){return(null==e?void 0:e[r.Type])===t}function d(e,t){return c(e,t[r.Type])}var f=Object.freeze({__proto__:null,isIsolateType:c,isSameIsolateIdentity:function(e,t){return Object.is(e,t)||d(e,t)&&e.key===t.key},isSameIsolateType:d});const y=n.createCascade(((e,n)=>{if(n)return null;t.invariant(e.historyRoot);const[r]=e.historyRoot(),i={};return t.assign(i,{historyNode:r,runtimeNode:null,runtimeRoot:null,stateRef:e}),i})),h=y.run,p={Run:h,addNodeToHistory:_,createRef:function(e,n){return Object.freeze({Bus:t.bus.createBus(),Reconciler:e,appData:t.optionalFunctionValue(n),historyRoot:t.tinyState.createTinyState(null)})},persist:v,reset:function(){const[,,e]=O();e()},useAvailableRoot:function(){const e=A();if(e)return e;const[t]=O();return t},useCurrentCursor:function(){const e=I();return e?a.cursor(e):0},useHistoryRoot:O,useLoadRootNode:function(e){E(e)},useXAppData:function(){return N().stateRef.appData}};function v(e){const t=y.useX();return(...n)=>{var r;const i=null!==(r=y.use())&&void 0!==r?r:t;return y.run(i.stateRef,(()=>e(...n)))}}function N(){return y.useX()}function O(){return N().stateRef.historyRoot()}function R(){return N().historyNode}function T(){const e=I(),t=R();return e?a.at(t,a.cursor(e)):t}function _(e){const n=I();n?function(e){const n=I();t.invariant(n,u.NO_ACTIVE_ISOLATE),l.addChild(n,e)}(e):E(e),l.setParent(e,n)}function E(e){const[,t]=O();t(e)}function I(){var e;return null!==(e=N().runtimeNode)&&void 0!==e?e:null}function A(){return N().runtimeRoot}class C{static reconcile(e){const n=function(e,n){var r;if(t.isNullish(n))return function(e){if(a.usesKey(e))return C.handleIsolateNodeWithKey(e);return e}(e);if(!d(e,n))return e;const i=N().stateRef.Reconciler;return null!==(r=i(e,n))&&void 0!==r?r:function(e,n){return t.isNullish(n),e}(e,n)}(e,T());return t.invariant(n,u.UNABLE_TO_PICK_NEXT_ISOLATE),n}static dropNextNodesOnReorder(e,t,n){const r=e(t,n);return r&&function(){const e=I(),t=R();if(!t||!e)return;l.slice(t,a.cursor(e))}(),r}static handleIsolateNodeWithKey(e){t.invariant(a.usesKey(e));const n=function(e){if(t.isNullish(e))return null;const n=N().historyNode;return a.getChildByKey(n,e)}(e.key);let r=e;return t.isNullish(n)||(r=n),function(e,n){if(!e)return;const r=I();t.invariant(r,u.NO_ACTIVE_ISOLATE),t.isNullish(a.getChildByKey(r,e))?l.addChildKey(r,e,n):t.deferThrow(t.text(u.ENCOUNTERED_THE_SAME_KEY_TWICE,{key:e}))}(e.key,e),r}}function m(e,n,r){if(t.isNullish(e.children))return;let i=!1;for(const s of e.children){if(i)return;if((t.isNullish(r)||t.optionalFunctionValue(r,s))&&n(s,o),i)return;m(s,((e,t)=>{n(e,(()=>{t(),o()}))}),r)}function o(){i=!0}}function K(e,t,n){let r=!1;return m(e,((e,n)=>{t(e)&&(n(),r=!0)}),n),r}function b(e,t){let n=e;do{if(t(n))return n;n=n.parent}while(n);return null}var k=Object.freeze({__proto__:null,closest:b,closestExists:function(e,t){return!!b(e,t)},every:function(e,t,n){let r=!0;return m(e,((e,n)=>{t(e)||(n(),r=!1)}),n),r},find:function(e,t,n){let r=null;return m(e,((e,n)=>{t(e)&&(n(),r=e)}),n),r},findClosest:function(e,t){var n,r;let i=null,o=e;for(;o&&(i=null!==(r=null===(n=o.children)||void 0===n?void 0:n.find(t))&&void 0!==r?r:null,!i);)o=o.parent;return i},has:function(e,t){return K(e,(()=>!0),t)},pluck:function(e,t,n){m(e,(e=>{t(e)&&e.parent&&l.removeChild(e.parent,e)}),n)},some:K,walk:m});function S(){return N().stateRef.Bus}function P(e,n){const r=S().emit;return t.isNullish(e)||r(e,n),v(r)}var w=Object.freeze({__proto__:null,useBus:S,useEmit:P,usePrepareEmitter:function(e){const t=P();return n=>t(e,n)}});class g{static deserialize(e){const n=t.isStringValue(e)?JSON.parse(e):Object.assign({},e);g.validateIsolate(n);const r=[n];for(;r.length;){const e=r.shift(),n=g.getChildren(e);for(const n in s){const r=e[n];t.isNotNullish(r)&&(e[s[n]]=r,delete e[n])}n&&(e.children=n.map((t=>{var n;const i=Object.assign({},t);l.setParent(i,e),r.push(i);const o=i.key;return o&&(e.keys=null!==(n=e.keys)&&void 0!==n?n:{},e.keys[o]=i),i})))}return n}static serialize(e){return t.isNullish(e)?"":JSON.stringify(j(e))}static getChildren(e){return e.children?[...e.children]:null}static validateIsolate(e){t.invariant(t.hasOwnProperty(e,r.Type)||t.hasOwnProperty(e,o[r.Type]),t.text(u.IVALID_ISOLATE_CANNOT_PARSE))}}function j(e){const n={};e.children&&(n.children=e.children.map(j));for(const r in e){if("children"===r)continue;if(D(r))continue;const i=e[r];t.isNullish(i)||(t.hasOwnProperty(o,r)?n[o[r]]=i:n[r]=i)}return n}function D(e){return[r.Parent,r.Keys].includes(e)}e.Bus=w,e.Isolate=class{static create(e,t,n,i){const o=I(),s=l.setParent(function(e,t,n=null){const i=null!=t?t:{},{allowReorder:o}=i,s=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(i,["allowReorder"]);return{[r.AllowReorder]:o,[r.Keys]:null,[r.Parent]:null,[r.Type]:e,[r.Data]:s,children:null,key:n,output:null}}(e,n,i),o),u=C.reconcile(s),a=T(),c=Object.is(u,s)?function(e,t,n){const r=A(),i=h(Object.assign({historyNode:e,runtimeNode:t},!r&&{runtimeRoot:t}),(()=>n(t)));return t.output=i,i}(a,s,t):u.output;return l.setParent(u,o),l.saveOutput(u,c),_(u),u}},e.IsolateInspector=a,e.IsolateMutator=l,e.IsolateSelectors=f,e.IsolateSerializer=g,e.Reconciler=C,e.VestRuntime=p,e.Walker=k}));
