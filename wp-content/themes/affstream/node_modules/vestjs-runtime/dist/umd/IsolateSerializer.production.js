!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vest-utils")):"function"==typeof define&&define.amd?define(["exports","vest-utils"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).IsolateSerializer={},e["vest-utils"])}(this,(function(e,t){"use strict";var i,n,s;!function(e){e.NO_ACTIVE_ISOLATE="Not within an active isolate",e.UNABLE_TO_PICK_NEXT_ISOLATE="Unable to pick next isolate. This is a bug, please report it to the Vest maintainers.",e.ENCOUNTERED_THE_SAME_KEY_TWICE='Encountered the same key "{key}" twice. This may lead to inconsistent or overriding of results.',e.IVALID_ISOLATE_CANNOT_PARSE="Invalid isolate was passed to IsolateSerializer. Cannot proceed."}(i||(i={})),function(e){e.Type="$type",e.Keys="keys",e.Key="key",e.Parent="parent",e.Data="data",e.AllowReorder="allowReorder"}(n||(n={})),function(e){e.Type="$",e.Keys="K",e.Key="k",e.Parent="P",e.Data="D",e.AllowReorder="aR"}(s||(s={}));const r={[n.Type]:s.Type,[n.Keys]:s.Keys,[n.Parent]:s.Parent,[n.Data]:s.Data,[n.Key]:s.Key,[n.AllowReorder]:s.AllowReorder},a=Object.entries(r).reduce(((e,[t,i])=>Object.assign(e,{[i]:t})),{});class l{static setParent(e,t){return e.parent=t,e}static saveOutput(e,t){return e.output=t,e}static setKey(e,t){return e.key=t,e}static addChild(e,i){var n;t.invariant(e),e.children=null!==(n=e.children)&&void 0!==n?n:[],e.children.push(i),l.setParent(i,e)}static removeChild(e,t){var i,n;e.children=null!==(n=null===(i=e.children)||void 0===i?void 0:i.filter((e=>e!==t)))&&void 0!==n?n:null}static addChildKey(e,i,n){var s;t.invariant(e),e.keys=null!==(s=e.keys)&&void 0!==s?s:{},e.keys[i]=n}static slice(e,i){t.isNullish(e.children)||(e.children.length=i)}static setData(e,t){e.data=t}}class o{static deserialize(e){const i=t.isStringValue(e)?JSON.parse(e):Object.assign({},e);o.validateIsolate(i);const n=[i];for(;n.length;){const e=n.shift(),i=o.getChildren(e);for(const i in a){const n=e[i];t.isNotNullish(n)&&(e[a[i]]=n,delete e[i])}i&&(e.children=i.map((t=>{var i;const s=Object.assign({},t);l.setParent(s,e),n.push(s);const r=s.key;return r&&(e.keys=null!==(i=e.keys)&&void 0!==i?i:{},e.keys[r]=s),s})))}return i}static serialize(e){return t.isNullish(e)?"":JSON.stringify(c(e))}static getChildren(e){return e.children?[...e.children]:null}static validateIsolate(e){t.invariant(t.hasOwnProperty(e,n.Type)||t.hasOwnProperty(e,r[n.Type]),t.text(i.IVALID_ISOLATE_CANNOT_PARSE))}}function c(e){const i={};e.children&&(i.children=e.children.map(c));for(const n in e){if("children"===n)continue;if(d(n))continue;const s=e[n];t.isNullish(s)||(t.hasOwnProperty(r,n)?i[r[n]]=s:i[n]=s)}return i}function d(e){return[n.Parent,n.Keys].includes(e)}e.IsolateSerializer=o}));
